---
title: "Problema 3 - Checkpoint 1"
author: Marcos Antonio Silva Nascimento (marcos.nascimento@ccc.ufcg.edu.br)
date: "16 de junho de 2017"
output: html_document
---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load_code}
library(tidyverse, warn.conflicts = F)
library(rvest)
library(plotly)
library(cluster)
library(ggdendro)
theme_set(theme_light())
source("plota_solucoes_hclust.R")

from_page <- read_html("https://www.rottentomatoes.com/celebrity/lindsay_lohan") %>% 
    html_node("#filmographyTbl") %>% # A sintaxe da expressão é de um seletor à lá JQuery: https://rdrr.io/cran/rvest/man/html_nodes.html 
    html_table(fill=TRUE) %>% # Faz parse
    as.tibble()

filmes = from_page %>% 
    filter(RATING != "No Score Yet", 
           `BOX OFFICE` != "—", 
            CREDIT != "Executive Producer") %>%
           mutate(RATING = as.numeric(gsub("%", "", RATING)), 
           `BOX OFFICE` = as.numeric(gsub("[$|M|k]", "", `BOX OFFICE`))) %>% 
    filter(`BOX OFFICE` != 'NA') # Tem sete filmes que não parecem ter sido lançados no mundo todo
```

# Tipos de filme de Lindsay Lohan
Neste post vamos investigar a existência de grupos de filmes com comportamentos comuns para os atuados pela atriz Lindsay Lohan. Previamente a atriz parece ter atuado em alguns filmes mais frequentemente quando fazia parte das estrelas Disney e nos dias atuais de forma mais esporádica. Será que existem grupos que definem comportamentos comuns para os filmes da atriz levando em consideração o sucesso de público e a crítica? Utilizaremos os dados cedidos pelo site Rotten Tomatoes.

Antes de mais nada precisamos descrever as variáveis que serão utilizadas para ver se já delineam a existência de grupos comuns de filmes. 

## A descrição
Vamos primeiramente olhar para o gráfico abaixo, veja como se comporta a distribuição de avaliação de cada filme da atriz.
```{r}
dist_avaliacao = filmes %>% 
  ggplot(aes(x = "Filmes", y = RATING, label = TITLE)) + 
    geom_jitter(width = .01, height = 0, size = 2, alpha = .6, color = "red") +
  labs(title = "Distribuição da avaliação do filme", x="Filmes", y="Avaliação") +
  theme(plot.title = element_text(hjust = 0.5))

ggplotly(dist_avaliacao)
```

Observando as avaliações dos filmes podemos observar uma tendência de grupos. Esses grupos ficam ainda mais evidentes quando geramos o gráfico de contagem de frequência de cada avaliação (vide abaixo). As avaliações mais próximas poderiam sugerir os grupos e os gaps os delimitadores entre cada um deles.
```{r}
filmes %>% 
    ggplot(aes(x = RATING)) + 
    geom_histogram(bins = 16, fill = "red", color = "black") + 
    geom_rug() +
   labs(title = "Histograma da avaliação", x="Avaliação", y = "Frequência") +
  theme(plot.title = element_text(hjust = 0.5))
```

Veja como se comporta a distribuição da renda de cada filme da atriz.
```{r}
dist_renda = filmes %>% 
    ggplot(aes(x = "Filmes", y = `BOX OFFICE`, label = TITLE)) + 
    geom_jitter(width = .02, height = 0, size = 2, alpha = .6, color = "red") +
  labs(title = "Distribuição da bilheteria", x="Filmes", y="Bilheteria") +
  theme(plot.title = element_text(hjust = 0.5))
ggplotly(dist_renda)
```

Podemos ver uma estrutura de grupo de filmes bem próximos quanto ao sucesso de público. O maior grupo define os filmes com bilheteria inferior a 40 milhões de dólares. Ainda sobre a bilheteria podemos observar se os valores de bilheteria são frequentes.
```{r}
filmes %>% 
    ggplot(aes(x = `BOX OFFICE`)) + 
    geom_histogram(bins = 20, fill = "red", color = "black") + 
    geom_rug() +
  labs(title = "Histograma de bilheteria", x="Bilheteria", y = "Frequência") +
  theme(plot.title = element_text(hjust = 0.5))
```

Quanto a frequência de bilheterias comuns observamos que a maioria dos valores de bilheteria são distintos e existem poucos valores duplicados. Poderia ser interessante analisar o comportamento da distribuição de bilheteria dos filmes em uma outra escala já que a concentração de valores de bilheteria impede uma melhor visualização da real magnitude dos valores.
```{r}
dist_renda_logscale = filmes %>% 
    ggplot(aes(x = "Filmes", y = `BOX OFFICE`, label=TITLE)) + 
    geom_jitter(width = .02, height = 0, size = 2, alpha = .6, color = "red") + 
    scale_y_log10() +
  labs(title = "Distribuição da bilheteria", x="Filmes", y="Bilheteria") +
  theme(plot.title = element_text(hjust = 0.5))
ggplotly(dist_renda_logscale)
```

Um valor de bilheteria que anteriormente parecia fazer parte de um grupo majoritário de valores contém o menor valor de bilheteria. Isso fica ainda mais evidente se olharmos o gráfico de histograma abaixo para a contagem de frequência de bilheteria de cada filme na escala logarítimica.
```{r}
filmes %>% 
    ggplot(aes(x = `BOX OFFICE`)) + 
    geom_histogram(bins = 20, fill = "red", color = "black") + 
    scale_x_log10() + 
    geom_rug() +
  labs(title = "Histograma de bilheteria", x="Bilheteria", y = "Frequência") +
  theme(plot.title = element_text(hjust = 0.5))
```

# Agrupamento com duas dimensões
```{r}
p = filmes %>% 
    ggplot(aes(x = RATING, y = `BOX OFFICE`, label = TITLE)) + 
    geom_point(color="red") 
ggplotly(p)
```

```{r}
agrupamento_h_2d = filmes %>% 
    column_to_rownames("TITLE") %>%
    select(RATING, `BOX OFFICE`) %>%
    dist(method = "euclidean") %>% 
    hclust(method = "centroid")

ggdendrogram(agrupamento_h_2d, rotate = TRUE) +
  geom_hline(yintercept = 35, colour = "red")

data.frame(k = NROW(agrupamento_h_2d$height):1, 
           height = agrupamento_h_2d$height) %>% 
    ggplot(aes(x = k, y = height)) + 
    geom_line(colour = "grey") + 
    geom_point() + 
    labs(x = "Número de clusters produzido", y = "Dissimilaridade na junção")
```

Como sempre, o algoritmo encontra grupos. No caso, parecem até bem separados. Vamos visualizá-los:
```{r}
plota_hclusts_2d(agrupamento_h_2d, 
                 filmes, 
                 c("RATING", "`BOX OFFICE`"), 
                 linkage_method = "centroid", ks = 1:6)
```

Observando o gráfico do dendrograma fica apropriado escolher 4 grupos já que os 4 grupos vão conter elementos menos distintos e mais característicos daquele grupo. Observando a tabela de filmes eu não observei muita discrepância entre os valores de BOX OFFICE e RATING e também observando o gráfico de agrupamento bidimensional eu não consigo observar que ou uma ou outra esteja sendo predominante na hora de realizar o agrupamento, por isto, acredito que a técnica de transformação de variável não seria necessária.

O agrupamento está acontecendo todo em função de BOX OFFICE, apenas. Como as escalas são diferentes, BOX OFFICE domina qualquer cálculo de distância euclidiana. 

Solução: standardize (aka scale).
```{r}
p2 = filmes %>% 
    ggplot(aes(x = RATING, y = `BOX OFFICE`, label = TITLE)) + 
    geom_point(color="red") +
  scale_y_log10()
ggplotly(p2)

agrupamento_h_2d = filmes %>% 
    column_to_rownames("TITLE") %>%
    select(RATING, `BOX OFFICE`) %>% 
    mutate(`BOX OFFICE` = log10(`BOX OFFICE`)) %>% 
    mutate_all(funs(scale)) %>% 
    dist(method = "euclidean") %>% 
    hclust(method = "centroid")

ggdendrogram(agrupamento_h_2d, rotate = TRUE)

filmes2 = filmes %>% mutate(`BOX OFFICE` = log10(`BOX OFFICE`))
plota_hclusts_2d(agrupamento_h_2d, 
                 filmes2, 
                 c("RATING", "`BOX OFFICE`"), 
                 linkage_method = "ward.D", ks = 1:6) + scale_y_log10()
```
```{r, warning=FALSE}
distancias = filmes %>% 
    column_to_rownames("TITLE") %>%
    select(RATING, `BOX OFFICE`) %>% 
    mutate(`BOX OFFICE` = log10(`BOX OFFICE`)) %>% 
    mutate_all(funs(scale)) %>% 
    dist(method = "euclidean")

plot(silhouette(cutree(agrupamento_h_2d, k = 5), distancias))
```

Observando o gráfico do dendrograma fica apropriado escolher 4 grupos já que os 4 grupos vão conter elementos menos distintos e mais característicos daquele grupo. Observando os grupos formados eles não são os mesmos da análise anterior.

---
title: "Problema 4 - Checkpoint 2"
author: "Marcos Antonio Silva Nascimento (marcos.nascimento@ccc.ufcg.edu.br)"
date: "17 de julho de 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(plotly)
library(GGally)
library(dplyr)
library(readr)
library(resample)
theme_set(theme_bw())
```

Responda 3 novas perguntas criadas por você e combinadas com o professor sobre os dados usados na Parte 1 envolvendo inferência estatística e utilizando bootstrap.

# O que esperar das avaliações dos filmes do site GroupLens?

Vamos estimar, a partir de uma amostra de opiniões, os intervalos de valores que delineam as avaliações de filmes do site [GroupLens](http://grouplens.org/datasets/movielens/latest/).

```{r, message=F, warning=F, results='hide'}
movies = read_csv("../dados/movies.csv")
ratings = read_csv("../dados/ratings.csv")
genres = read_csv("../dados/movie-genre.csv")
genres = genres %>%
  group_by(movieId, title) %>%
  summarise(nGenre = n())
```

##  O que esperar dos telespectadores em termos de avaliação de Resident Evil?

Ainda sobre o suscesso dos filmes de Resident Evil queremos saber o que esperar em termos de avaliação dos usuários do GroupLens. Quem são os usuários e como eles votam? Quais suas avaliações?

Para começar vamos precisar relembrar os achados do checkpoint anterior e adotar uma métrica de comparação entre as avaliações de cada telespectador. No checkpoint anterior vimos que os episódios Afterlife (2010) e Retribution (2012) são os que contém menos avaliações e por isso vamos responder as perguntas apenas para os demais episódios (intervalos de confiança precisam de um número significativo de observações).

```{r, message=F, warning=F, results='hide'}
re_movies = movies %>% 
  filter(grepl("Resident Evil", title)) %>%
  filter(!(title %in% c("Resident Evil: Afterlife (2010)",
                        "Resident Evil: Retribution (2012)")))
re_movies = re_movies %>% 
  mutate(title = replace(title,
                         which(title == "Resident Evil: Apocalypse (2004)"),
                         "Apocalypse (2004)")) %>%
  mutate(title = replace(title,
                         which(title == "Resident Evil: Extinction (2007)"),
                         "Extinction (2007)"))

dados = merge(re_movies, ratings, by="movieId") %>%
  subset(select = -c(movieId, title, genres, timestamp))
```

### Descritivo e decisões sobre filtrar dados ou variáveis 

Antes de mais nada podemos nos perguntar: como se comporta a distribuição de avaliação de cada um dos usuários?
```{r message=F, warning=F}
ggplotly(dados %>%
  ggplot(aes(x=as.character(userId),
             y=rating,
             color=as.character(userId))) +
  geom_jitter(width = .1) +
    geom_boxplot() +
  ggtitle("Distribuição da avaliação dos usuários") +
  ylab("Avaliação") +
  xlab("Usuário") +
  theme(legend.position="none",
        plot.title = element_text(hjust = 0.5)))
```

Podemos observar no gráfico acima algumas coisas curiosas. A pior avaliação de Resident Evil foi do usuário de id 165 (0.5). As outras duas piores notas foram dos usuários 15 e 475 (1). Apenas dois usuários, 346 e 78, deram as notas mais altas (5).

Curiosamente o conjunto de dados também não contém muitas avaliações para cada um dos usuários do GroupLens.
```{r message=F, warning=F}
ggplotly(dados %>%
           ggplot(aes(x=as.character(userId),
                      color=as.character(userId),
                      fill=as.character(userId))) +
           geom_bar(width = .5) +
  ggtitle("Distribuição da quantidade de avaliação dos usuários") +
    scale_y_continuous(breaks = seq(1,3,1)) +
  ylab("Quantidade") +
  xlab("Usuário") +
  theme(legend.position="none",
        plot.title = element_text(hjust = 0.5)))
```

Em maioria os telespectadores votaram apenas uma vez e a quantidade máxima de avaliação observada é 3. Como não é interessante estimarmos em cima de poucas observações então obviamente não devemos estimar valores para os telespectadores que votaram apenas uma vez. Esses valores serão filtrados.

```{r}
dados = dados %>%
  group_by(userId) %>%
  filter(n() > 1)
```

Você poderia estar imaginando: qual dos usuários, que votaram mais de uma vez, forneceram as melhores avaliações? E as piores?
```{r}
ggplotly(dados %>%
  ggplot(aes(x=as.character(userId),
             y=rating,
             color=as.character(userId))) +
  geom_jitter(width = .1) +
    geom_boxplot() +
  ggtitle("Distribuição da avaliação dos usuários") +
  ylab("Avaliação") +
  xlab("Usuário") +
  theme(legend.position="none",
        plot.title = element_text(hjust = 0.5)))
```

Em termos de mediana de avaliação podemos observar duas coisas importantes: os usuários que melhor avaliaram e os que pior avaliaram. Apenas o usuário de Id 78 melhor avaliou os filmes (4.5), e apenas o usuário 475 pior avaliou os filmes (1.5).

### Qual dos telespectadores de Resident Evil mais bem avalia os filmes? Para qual deles há melhor avaliação? E para qual há maior variação de avaliação?

```{r message=F, warning=F}
bootf <- function(x) {
    b =  bootstrap(x$rating, median, R = 1000)
    m = CI.percentile(b, probs = c(.025, .975))
    newstuff = rbind(m) %>%
      data.frame()
    return(newstuff)
}

dados.ci = dados %>%
  group_by(userId) %>%
  do(bootf(.)) %>%
  setNames(c("userId","rating_lwr","rating_upr"))
```
Qual seria a expectativa de mediana de avaliação para cada um dos telespectadores de Resident Evil?
```{r message=F, warning=F}
dados.ci %>%
  ggplot(aes(x = as.character(userId),
             ymin = rating_lwr,
             ymax = rating_upr,
             color=as.character(userId))) + 
  geom_errorbar(width = .1) +
  labs(x="Usuário", y="Mediana de avaliação") +
  ggtitle("Intervalo de confiança da mediana de avaliação de cada usuário")+
  theme(legend.position="none",
        plot.title = element_text(hjust = 0.5))
```

A expectativa de avaliação mediana pode ser observada logo acima. O usuário 78, por exemplo, pode fornecer a mediana de avaliação aos episódios de Resident Evil variando entre 4.5 e 5. Em adicional também seria o único que poderia fornecer a maior mediana de avaliação se comparado com os intervalos de confiança dos demais usuários.

Quanto a variação podemos concluir que tanto o usuário 199 quanto o usuário 384, podem ser os campeões em variação de mediana de avaliação na hora de avaliar os episódios.

## O que esperar dos telespectadores em termos de avaliação dos filmes?

Agora de uma forma mais geral qual dos telespectadores mais bem avalia os filmes do GroupLens. Quem são os usuários e como eles votam? Quais suas avaliações?

```{r}
dados = ratings %>%
  subset(select = -c(movieId,timestamp))
# get randomized data using "sample_n(df, 10)"
x= dados %>%
  group_by(userId) %>%
  summarise(nRating=n(), medianRating=median(rating))
```

### Descritivo e decisões sobre filtrar dados ou variáveis 
Antes de mais nada podemos nos perguntar: como se comporta a distribuição de avaliação de cada um dos usuários?
```{r message=F, warning=F}
ggplotly(x %>%
  ggplot(aes(x=as.character(userId),
             y=nRating)) +
  geom_jitter(width = .1, color="red") +
  ggtitle("Distribuição da quantidade de avaliação dos usuários") +
  ylab("Quantidade") +
  xlab("Usuário") +
  theme(legend.position="none",
        plot.title = element_text(hjust = 0.5)))
```

```{r}
ggplotly(x %>%
  ggplot(aes(x=as.character(userId),
             y=medianRating)) +
  geom_jitter(width = .1, color="red") +
  ggtitle("Distribuição da avaliação dos usuários") +
  ylab("Mediana de avaliação") +
  xlab("Usuário") +
  theme(legend.position="none",
        plot.title = element_text(hjust = 0.5)))
```

### Qual dos telespectadores mais bem avalia os filmes? Para qual deles há melhor avaliação? E para qual há maior variação de avaliação?

```{r}
dados2 = dados %>%
  group_by(userId) %>%
  do(bootf(.)) %>%
  setNames(c("userId","rating_lwr","rating_upr"))
```

```{r}
dados2 %>%
  ggplot(aes(x = as.character(userId),
             ymin = rating_lwr,
             ymax = rating_upr)) + 
  geom_errorbar(width = .1) +
  labs(x="Id do usuário", y="Mediana de avaliação") +
  ggtitle("Intervalo de confiança da mediana de avaliação de cada usuário")+
  theme(legend.position="none",
        plot.title = element_text(hjust = 0.5))
```

## O que esperar dos telespectadores em termos de avaliação dos gêneros de filmes?

```{r}
genres = read_csv("../dados/movie-genre.csv")
dados = merge(genres, ratings, by="movieId") %>%
  subset(select = -c(movieId, title, userId, timestamp))
x= dados %>%
  group_by(genre) %>%
  summarise(nRating=n(), medianRating=median(rating))
```

### Descritivo e decisões sobre filtrar dados ou variáveis 

```{r}
x = x %>% filter(genre != '(no genres listed)')

ggplotly(x %>%
  ggplot(aes(x=genre,
             y=nRating)) +
  geom_jitter(width = .1, color="red") +
  ggtitle("Distribuição da quantidade de avaliação dos gêneros") +
  ylab("Quantidade") +
  xlab("Gênero") +
  theme(legend.position="none",
        plot.title = element_text(hjust = 0.5)))
```

```{r}
ggplotly(x %>%
  ggplot(aes(x=genre,
             y=medianRating)) +
  geom_jitter(width = .1, color="red") +
  ggtitle("Distribuição da avaliação dos gêneros") +
  ylab("Mediana de avaliação") +
  xlab("Gênero") +
  theme(legend.position="none",
        plot.title = element_text(hjust = 0.5)))
```

### Qual dos gêneros é mais bem avaliado nos filmes? Para qual deles há melhor avaliação? E para qual há maior variação de avaliação?

```{r}
dados2 = dados %>%
  filter(genre != '(no genres listed)') %>%
  group_by(genre) %>%
  do(bootf(.)) %>%
  setNames(c("genre","rating_lwr","rating_upr"))
```

```{r}
dados2 %>%
  ggplot(aes(x = genre,
             ymin = rating_lwr,
             ymax = rating_upr)) + 
  geom_errorbar(width = .1) +
  labs(x="Gênero", y="Mediana de avaliação") +
  ggtitle("Intervalo de confiança da mediana de avaliação de cada gênero")+
  theme(legend.position="none",
        plot.title = element_text(hjust = 0.5))
```


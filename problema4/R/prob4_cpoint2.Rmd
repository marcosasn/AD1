---
title: "Problema 4 - Checkpoint 2"
author: "Marcos Antonio Silva Nascimento (marcos.nascimento@ccc.ufcg.edu.br)"
date: "17 de julho de 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(plotly)
library(GGally)
library(dplyr)
library(readr)
library(resample)
theme_set(theme_bw())
```

Responda 3 novas perguntas criadas por você e combinadas com o professor sobre os dados usados na Parte 1 envolvendo inferência estatística e utilizando bootstrap.

# O que esperar das avaliações dos filmes do site GroupLens?

Vamos estimar, a partir de uma amostra de opiniões, os intervalos de valores que delineam as avaliações de filmes do site [GroupLens](http://grouplens.org/datasets/movielens/latest/).

```{r, message=F, warning=F, results='hide'}
movies = read_csv("../dados/movies.csv")
ratings = read_csv("../dados/ratings.csv")
genres = read_csv("../dados/movie-genre.csv")
genres = genres %>%
  group_by(movieId, title) %>%
  summarise(nGenre = n())
```

##  Qual dos telespectadores de Resident Evil mais bem avalia os filmes? Para qual deles há melhor avaliação? E para qual há maior variação de avaliação?

Para responder cada uma das perguntas vamos precisar relembrar os achados do checkpoint anterior e adotar uma métrica de comparação entre as avaliações de cada telespectador. No checkpoint anterior vimos que os episódios Afterlife (2010) e Retribution (2012) são os que contém menos avaliações e por isso vamos responder as perguntas apenas para os demais episódios.

```{r}
re_movies = movies %>% 
  filter(grepl("Resident Evil", title)) %>%
  filter(!(title %in% c("Resident Evil: Afterlife (2010)",
                        "Resident Evil: Retribution (2012)")))
dados = re_movies %>% 
  mutate(title = replace(title,
                         which(title == "Resident Evil: Apocalypse (2004)"),
                         "Apocalypse (2004)")) %>%
  mutate(title = replace(title,
                         which(title == "Resident Evil: Extinction (2007)"),
                         "Extinction (2007)"))

dados = merge(re_movies, ratings, by="movieId") %>%
  subset(select = -c(movieId, title, genres, timestamp))
```

Quantificando as avaliações podemos quantificar as audiêcias de cada filme. O ranking de audiência tem Resident Evil em primeira posição, Apocalypse em segunda e Extinction em terceira.

```{r}
ggplotly(dados %>%
  ggplot(aes(x=userId,y=rating)) +
  geom_point())

dados2 = dados %>%
        group_by(userId) %>%
        summarise(nRating=n())

ggplotly(dados2 %>%
           ggplot(aes(x=userId,y=nRating)) +
           geom_point())
```

```{r}
bootf <- function(x) {
    b =  bootstrap(x$rating, median, R = 1000)
    m = CI.percentile(b, probs = c(.025, .975))
    newstuff = rbind(m) %>%
      data.frame()
    return(newstuff)
}

dados3 = dados %>%
  group_by(userId) %>%
  filter(n() > 1) %>%
  do(bootf(.)) %>%
  setNames(c("userId","rating_lwr","rating_upr"))

```
```{r}
dados3 %>%
  ggplot(aes(x = as.character(userId),
             ymin = rating_lwr,
             ymax = rating_upr,
             color=as.character(userId))) + 
  geom_errorbar(width = .1) +
  labs(x="Id do usuário", y="Mediana de avaliação") +
  ggtitle("Intervalo de confiança da mediana de avaliação de cada usuário")+
  theme(legend.position="none",
        plot.title = element_text(hjust = 0.5))
```

## Quais os gêneros de filmes mais bem avaliados?

```{r}

```

## Os filmes com maior quantidade de gênero são mais bem avaliados?

```{r}
```